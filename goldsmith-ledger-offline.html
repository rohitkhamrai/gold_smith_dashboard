<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goldsmith Ledger - Offline</title>
    <meta name="theme-color" content="#f59e0b">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR29sZHNtaXRoIExlZGdlciIsInNob3J0X25hbWUiOiJMZWRnZXIiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2Y1OWUwYiIsInRoZW1lX2NvbG9yIjoiI2Y1OWUwYiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3BuZztiYXNlNjQsaVZCT1J3MEtHZ29BQUFBTlNVaEVVZ0FBQUJnQUFBQVlDQVlBQUFEZ2R6K0FBQUFBWGNTUURBQUE3IiwidHlwZSI6ImltYWdlL3BuZyIsInNpemVzIjoiMTkyeDE5MiJ9XX0=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        /* Header */
        .header {
            background-color: #f59e0b;
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.875rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .header p {
            color: #fef3c7;
        }
        
        /* Navigation */
        .nav {
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 0;
        }
        
        .nav-container {
            display: flex;
            gap: 2rem;
        }
        
        .nav-button {
            padding: 1rem 0.5rem;
            border: none;
            background: none;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #6b7280;
            transition: all 0.2s;
        }
        
        .nav-button:hover {
            color: #374151;
        }
        
        .nav-button.active {
            border-bottom-color: #f59e0b;
            color: #f59e0b;
        }
        
        /* Main Content */
        .main {
            padding: 2rem 0;
        }
        
        .card {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        .card h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1.5rem;
        }
        
        /* Dashboard Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            text-align: center;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .stat-gold { background-color: #fef3c7; color: #92400e; }
        .stat-money { background-color: #d1fae5; color: #065f46; }
        .stat-jobs { background-color: #dbeafe; color: #1e40af; }
        .stat-customers { background-color: #e0e7ff; color: #5b21b6; }
        .stat-transactions { background-color: #f3f4f6; color: #374151; }
        
        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }
        
        .form-input, .form-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }
        
        /* Buttons */
        .btn {
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover { background-color: #059669; }
        
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-warning:hover { background-color: #d97706; }
        
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        
        .table tr:hover {
            background-color: #f9fafb;
        }
        
        /* Colors */
        .text-gold { color: #f59e0b; }
        .text-green { color: #10b981; }
        .text-blue { color: #3b82f6; }
        .text-red { color: #ef4444; }
        .text-gray { color: #6b7280; }
        
        /* Utilities */
        .hidden { display: none; }
        .flex { display: flex; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .text-sm { font-size: 0.875rem; }
        .font-medium { font-weight: 500; }
        .text-center { text-align: center; }
        
        /* Status badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-progress { background-color: #fef3c7; color: #92400e; }
        .status-completed { background-color: #dbeafe; color: #1e40af; }
        .status-delivered { background-color: #d1fae5; color: #065f46; }
        
        /* Export/Import section */
        .export-section {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .export-section h3 {
            margin-bottom: 0.5rem;
            color: #374151;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-container {
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .table {
                font-size: 0.875rem;
            }
            
            .table th,
            .table td {
                padding: 0.5rem;
            }
        }
        
        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Offline Indicator -->
    <div class="offline-indicator">
        üì± Offline Mode
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1>‚ú® Goldsmith Ledger</h1>
            <p>Offline digital ledger for your goldsmith business</p>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="container">
            <div class="nav-container">
                <button class="nav-button active" onclick="showTab('dashboard')">üìä Dashboard</button>
                <button class="nav-button" onclick="showTab('customers')">üë• Customers</button>
                <button class="nav-button" onclick="showTab('transactions')">üí≥ Transactions</button>
                <button class="nav-button" onclick="showTab('jobs')">üî® Jobs</button>
                <button class="nav-button" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="card">
                <h2>üìä Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card stat-gold">
                        <div class="stat-value" id="total-gold">0g</div>
                        <div class="stat-label">Gold Balance</div>
                    </div>
                    <div class="stat-card stat-money">
                        <div class="stat-value" id="total-money">‚Çπ0</div>
                        <div class="stat-label">Money Balance</div>
                    </div>
                    <div class="stat-card stat-jobs">
                        <div class="stat-value" id="active-jobs">0</div>
                        <div class="stat-label">Active Jobs</div>
                    </div>
                    <div class="stat-card stat-customers">
                        <div class="stat-value" id="total-customers">0</div>
                        <div class="stat-label">Customers</div>
                    </div>
                    <div class="stat-card stat-transactions">
                        <div class="stat-value" id="total-transactions">0</div>
                        <div class="stat-label">Transactions</div>
                    </div>
                </div>
            </div>

            <!-- Customers Tab -->
            <div id="customers" class="card hidden">
                <h2>üë• Customer Management</h2>
                
                <!-- Add Customer Form -->
                <div class="export-section">
                    <h3>Add New Customer</h3>
                    <form id="customer-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Customer Name *</label>
                                <input type="text" id="customer-name" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="tel" id="customer-phone" class="form-input">
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <input type="text" id="customer-notes" class="form-input">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-4">Add Customer</button>
                    </form>
                </div>

                <!-- Customer List -->
                <div class="table-container">
                    <p class="text-sm text-gray mb-4">üí° Click on any customer name to view their transaction history</p>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Notes</th>
                                <th>Added</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customers-list">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactions" class="card hidden">
                <h2>üí≥ Transaction Ledger</h2>
                
                <!-- Add Transaction Form -->
                <div class="export-section">
                    <h3>Add New Transaction</h3>
                    <form id="transaction-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Customer *</label>
                                <select id="transaction-customer" class="form-select" required>
                                    <option value="">Select Customer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Work Description *</label>
                                <input type="text" id="transaction-work" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="transaction-date" class="form-input">
                            </div>
                            <div class="form-group">
                                <label>Gold In (grams)</label>
                                <input type="number" id="transaction-gold-in" class="form-input" step="0.001" min="0">
                            </div>
                            <div class="form-group">
                                <label>Gold Out (grams)</label>
                                <input type="number" id="transaction-gold-out" class="form-input" step="0.001" min="0">
                            </div>
                            <div class="form-group">
                                <label>Cash In (‚Çπ)</label>
                                <input type="number" id="transaction-cash-in" class="form-input" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label>Labour Charge (‚Çπ)</label>
                                <input type="number" id="transaction-labour" class="form-input" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label>Remarks</label>
                                <input type="text" id="transaction-remarks" class="form-input">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success mt-4">Add Transaction</button>
                    </form>
                </div>

                <!-- Transaction List -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Work</th>
                                <th>Gold In</th>
                                <th>Gold Out</th>
                                <th>Cash In</th>
                                <th>Labour</th>
                                <th>Remarks</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-list">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Jobs Tab -->
            <div id="jobs" class="card hidden">
                <h2>üî® Job Tracker</h2>
                
                <!-- Add Job Form -->
                <div class="export-section">
                    <h3>Create New Job</h3>
                    <form id="job-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Customer *</label>
                                <select id="job-customer" class="form-select" required>
                                    <option value="">Select Customer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Work Description *</label>
                                <input type="text" id="job-work" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="job-status" class="form-select">
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Delivered">Delivered</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Expected Delivery</label>
                                <input type="date" id="job-delivery" class="form-input">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-warning mt-4">Create Job</button>
                    </form>
                </div>

                <!-- Job List -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Work Description</th>
                                <th>Status</th>
                                <th>Expected Delivery</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="jobs-list">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="card hidden">
                <h2>‚öôÔ∏è Settings & Data Management</h2>
                
                <!-- Search Section -->
                <div class="export-section">
                    <h3>üîç Search & Filter</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Search Customers</label>
                            <input type="text" id="search-customers" class="form-input" placeholder="Search by name or phone..." onkeyup="searchCustomers()">
                        </div>
                        <div class="form-group">
                            <label>Filter Transactions by Date</label>
                            <input type="date" id="filter-date-from" class="form-input" onchange="filterTransactions()">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="filter-date-to" class="form-input" onchange="filterTransactions()">
                        </div>
                    </div>
                    <button onclick="clearFilters()" class="btn btn-primary mt-4">Clear Filters</button>
                </div>

                <!-- Auto Backup Section -->
                <div class="export-section">
                    <h3>üíæ Auto Backup</h3>
                    <p class="text-sm text-gray mb-4">Automatically backup your data every week</p>
                    <div class="flex gap-2 mb-4">
                        <label>
                            <input type="checkbox" id="auto-backup" onchange="toggleAutoBackup()"> Enable Weekly Auto Backup
                        </label>
                    </div>
                    <p class="text-sm text-gray">Last backup: <span id="last-backup">Never</span></p>
                </div>
                
                <!-- Export/Import Section -->
                <div class="export-section">
                    <h3>üì§ Export Data</h3>
                    <p class="text-sm text-gray mb-4">Download your data to transfer between devices or backup</p>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="exportData()" class="btn btn-primary">Export All Data</button>
                        <button onclick="exportPDF()" class="btn btn-warning">Export PDF Report</button>
                        <button onclick="exportCSV()" class="btn btn-success">Export CSV</button>
                        <button onclick="exportCustomerReport()" class="btn btn-primary">Customer Reports</button>
                    </div>
                </div>

                <div class="export-section">
                    <h3>üì• Import Data</h3>
                    <p class="text-sm text-gray mb-4">Import data from another device (this will merge with current data)</p>
                    <div class="flex gap-2 mb-4">
                        <input type="file" id="import-file" accept=".json" class="form-input">
                        <button onclick="importData()" class="btn btn-success">Import Data</button>
                    </div>
                    <div class="flex gap-2">
                        <input type="file" id="replace-file" accept=".json" class="form-input">
                        <button onclick="replaceData()" class="btn btn-warning">Replace All Data</button>
                    </div>
                </div>

                <!-- Business Settings -->
                <div class="export-section">
                    <h3>üè™ Business Settings</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Business Name</label>
                            <input type="text" id="business-name" class="form-input" placeholder="Your Goldsmith Shop Name">
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="business-address" class="form-input" placeholder="Shop Address">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="business-phone" class="form-input" placeholder="Contact Number">
                        </div>
                        <div class="form-group">
                            <label>Currency Symbol</label>
                            <select id="currency-symbol" class="form-select">
                                <option value="‚Çπ">‚Çπ (Indian Rupee)</option>
                                <option value="$">$ (Dollar)</option>
                                <option value="‚Ç¨">‚Ç¨ (Euro)</option>
                                <option value="¬£">¬£ (Pound)</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="saveBusinessSettings()" class="btn btn-primary mt-4">Save Settings</button>
                </div>

                <div class="export-section">
                    <h3>üóëÔ∏è Clear All Data</h3>
                    <p class="text-sm text-gray mb-4">Warning: This will permanently delete all customers, transactions, and jobs</p>
                    <button onclick="clearAllData()" class="btn btn-danger">Clear All Data</button>
                </div>

                <div class="export-section">
                    <h3>üìä Data Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-card stat-customers">
                            <div class="stat-value" id="settings-customers">0</div>
                            <div class="stat-label">Total Customers</div>
                        </div>
                        <div class="stat-card stat-transactions">
                            <div class="stat-value" id="settings-transactions">0</div>
                            <div class="stat-label">Total Transactions</div>
                        </div>
                        <div class="stat-card stat-jobs">
                            <div class="stat-value" id="settings-jobs">0</div>
                            <div class="stat-label">Total Jobs</div>
                        </div>
                        <div class="stat-card stat-gold">
                            <div class="stat-value" id="settings-data-size">0 KB</div>
                            <div class="stat-label">Data Size</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Detail Modal (hidden by default) -->
            <div id="customer-detail" class="card hidden">
                <div class="flex gap-4 mb-4">
                    <button onclick="showCustomerList()" class="btn btn-primary">‚Üê Back to Customers</button>
                </div>
                <h2 id="customer-detail-title">Customer Details</h2>
                
                <!-- Customer Balance -->
                <div class="stats-grid mb-4">
                    <div class="stat-card stat-gold">
                        <div class="stat-value" id="customer-gold-balance">0g</div>
                        <div class="stat-label">Gold Balance</div>
                    </div>
                    <div class="stat-card stat-money">
                        <div class="stat-value" id="customer-money-balance">‚Çπ0</div>
                        <div class="stat-label">Money Balance</div>
                    </div>
                </div>

                <!-- Customer Transactions -->
                <h3 class="mb-4">Transaction History</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Work</th>
                                <th>Gold In</th>
                                <th>Gold Out</th>
                                <th>Cash In</th>
                                <th>Labour</th>
                                <th>Remarks</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customer-transactions-list">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Data storage
        let customers = JSON.parse(localStorage.getItem('goldsmith_customers') || '[]');
        let transactions = JSON.parse(localStorage.getItem('goldsmith_transactions') || '[]');
        let jobs = JSON.parse(localStorage.getItem('goldsmith_jobs') || '[]');
        let businessSettings = JSON.parse(localStorage.getItem('goldsmith_business_settings') || '{}');
        let currentCustomer = null;
        let filteredCustomers = [];
        let filteredTransactions = [];

        // Initialize business settings defaults
        if (!businessSettings.currencySymbol) businessSettings.currencySymbol = '‚Çπ';
        if (!businessSettings.businessName) businessSettings.businessName = '';
        if (!businessSettings.businessAddress) businessSettings.businessAddress = '';
        if (!businessSettings.businessPhone) businessSettings.businessPhone = '';

        // Utility functions
        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }

        function saveData() {
            localStorage.setItem('goldsmith_customers', JSON.stringify(customers));
            localStorage.setItem('goldsmith_transactions', JSON.stringify(transactions));
            localStorage.setItem('goldsmith_jobs', JSON.stringify(jobs));
            localStorage.setItem('goldsmith_business_settings', JSON.stringify(businessSettings));
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString();
        }

        function formatCurrency(amount) {
            return businessSettings.currencySymbol + parseFloat(amount || 0).toFixed(2);
        }

        function calculateDataSize() {
            const data = {
                customers: customers,
                transactions: transactions,
                jobs: jobs,
                businessSettings: businessSettings
            };
            const sizeInBytes = new Blob([JSON.stringify(data)]).size;
            if (sizeInBytes < 1024) return sizeInBytes + ' B';
            if (sizeInBytes < 1024 * 1024) return (sizeInBytes / 1024).toFixed(1) + ' KB';
            return (sizeInBytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Navigation
        function showTab(tabName) {
            // Hide all tabs
            const tabs = ['dashboard', 'customers', 'transactions', 'jobs', 'settings', 'customer-detail'];
            tabs.forEach(tab => {
                document.getElementById(tab).classList.add('hidden');
            });

            // Show selected tab
            document.getElementById(tabName).classList.remove('hidden');

            // Update nav buttons
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Refresh data when switching tabs
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'customers') updateCustomersList();
            if (tabName === 'transactions') updateTransactionsList();
            if (tabName === 'jobs') updateJobsList();
            if (tabName === 'settings') updateSettings();
        }

        // Dashboard functions
        function updateDashboard() {
            let totalGold = 0;
            let totalMoney = 0;
            
            transactions.forEach(t => {
                totalGold += (parseFloat(t.goldIn) || 0) - (parseFloat(t.goldOut) || 0);
                totalMoney += (parseFloat(t.cashIn) || 0) + (parseFloat(t.labourCharge) || 0);
            });

            const activeJobs = jobs.filter(j => j.status === 'In Progress' || j.status === 'Completed').length;

            document.getElementById('total-gold').textContent = totalGold.toFixed(3) + 'g';
            document.getElementById('total-money').textContent = formatCurrency(totalMoney);
            document.getElementById('active-jobs').textContent = activeJobs;
            document.getElementById('total-customers').textContent = customers.length;
            document.getElementById('total-transactions').textContent = transactions.length;
        }

        // Customer functions
        function updateCustomersList() {
            const tbody = document.getElementById('customers-list');
            tbody.innerHTML = '';

            const displayCustomers = filteredCustomers.length > 0 ? filteredCustomers : customers;

            displayCustomers.forEach(customer => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><button onclick="showCustomerDetail('${customer.id}')" class="text-blue font-medium">${customer.name}</button></td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.notes || '-'}</td>
                    <td>${formatDate(customer.createdAt)}</td>
                    <td>
                        <button onclick="deleteCustomer('${customer.id}')" class="btn btn-danger">üóëÔ∏è Delete</button>
                    </td>
                `;
            });

            updateCustomerDropdowns();
        }

        function searchCustomers() {
            const searchTerm = document.getElementById('search-customers').value.toLowerCase();
            if (searchTerm === '') {
                filteredCustomers = [];
            } else {
                filteredCustomers = customers.filter(customer => 
                    customer.name.toLowerCase().includes(searchTerm) ||
                    (customer.phone && customer.phone.includes(searchTerm))
                );
            }
            updateCustomersList();
        }

        function updateCustomerDropdowns() {
            const selects = ['transaction-customer', 'job-customer'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select Customer</option>';
                customers.forEach(customer => {
                    select.innerHTML += `<option value="${customer.id}">${customer.name}</option>`;
                });
            });
        }

        function showCustomerDetail(customerId) {
            currentCustomer = customers.find(c => c.id === customerId);
            if (!currentCustomer) return;

            document.getElementById('customers').classList.add('hidden');
            document.getElementById('customer-detail').classList.remove('hidden');
            document.getElementById('customer-detail-title').textContent = `üìã ${currentCustomer.name}'s Account`;

            // Calculate customer balance
            let goldBalance = 0;
            let moneyBalance = 0;
            const customerTransactions = transactions.filter(t => t.customerId === customerId);
            
            customerTransactions.forEach(t => {
                goldBalance += (parseFloat(t.goldIn) || 0) - (parseFloat(t.goldOut) || 0);
                moneyBalance += (parseFloat(t.cashIn) || 0) + (parseFloat(t.labourCharge) || 0);
            });

            document.getElementById('customer-gold-balance').textContent = goldBalance.toFixed(3) + 'g';
            document.getElementById('customer-money-balance').textContent = formatCurrency(moneyBalance);

            // Update transactions list
            const tbody = document.getElementById('customer-transactions-list');
            tbody.innerHTML = '';
            customerTransactions.forEach(transaction => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.workDescription}</td>
                    <td class="text-gold">${transaction.goldIn || 0}g</td>
                    <td class="text-red">${transaction.goldOut || 0}g</td>
                    <td class="text-green">${formatCurrency(transaction.cashIn)}</td>
                    <td class="text-blue">${formatCurrency(transaction.labourCharge)}</td>
                    <td>${transaction.remarks || '-'}</td>
                    <td>
                        <button onclick="deleteTransaction('${transaction.id}')" class="btn btn-danger">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function showCustomerList() {
            document.getElementById('customer-detail').classList.add('hidden');
            document.getElementById('customers').classList.remove('hidden');
            currentCustomer = null;
        }

        // Transaction functions
        function updateTransactionsList() {
            const tbody = document.getElementById('transactions-list');
            tbody.innerHTML = '';

            const displayTransactions = filteredTransactions.length > 0 ? filteredTransactions : transactions;
            const sortedTransactions = [...displayTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedTransactions.forEach(transaction => {
                const customer = customers.find(c => c.id === transaction.customerId);
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td class="font-medium">${customer ? customer.name : 'Unknown'}</td>
                    <td>${transaction.workDescription}</td>
                    <td class="text-gold">${transaction.goldIn || 0}g</td>
                    <td class="text-red">${transaction.goldOut || 0}g</td>
                    <td class="text-green">${formatCurrency(transaction.cashIn)}</td>
                    <td class="text-blue">${formatCurrency(transaction.labourCharge)}</td>
                    <td>${transaction.remarks || '-'}</td>
                    <td>
                        <button onclick="deleteTransaction('${transaction.id}')" class="btn btn-danger">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function filterTransactions() {
            const fromDate = document.getElementById('filter-date-from').value;
            const toDate = document.getElementById('filter-date-to').value;
            
            if (!fromDate && !toDate) {
                filteredTransactions = [];
            } else {
                filteredTransactions = transactions.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    const from = fromDate ? new Date(fromDate) : new Date('1900-01-01');
                    const to = toDate ? new Date(toDate) : new Date('2099-12-31');
                    return transactionDate >= from && transactionDate <= to;
                });
            }
            updateTransactionsList();
        }

        function clearFilters() {
            document.getElementById('search-customers').value = '';
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            filteredCustomers = [];
            filteredTransactions = [];
            updateCustomersList();
            updateTransactionsList();
        }

        // Job functions
        function updateJobsList() {
            const tbody = document.getElementById('jobs-list');
            tbody.innerHTML = '';

            jobs.forEach(job => {
                const customer = customers.find(c => c.id === job.customerId);
                const row = tbody.insertRow();
                const statusClass = job.status === 'In Progress' ? 'status-progress' : 
                                   job.status === 'Completed' ? 'status-completed' : 'status-delivered';
                
                row.innerHTML = `
                    <td class="font-medium">${customer ? customer.name : 'Unknown'}</td>
                    <td>${job.workDescription}</td>
                    <td><span class="status-badge ${statusClass}">${job.status}</span></td>
                    <td>${job.expectedDelivery ? formatDate(job.expectedDelivery) : '-'}</td>
                    <td>
                        <div class="flex gap-2">
                            <select onchange="updateJobStatus('${job.id}', this.value)" class="form-select">
                                <option value="In Progress" ${job.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                <option value="Completed" ${job.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                <option value="Delivered" ${job.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            </select>
                            <button onclick="deleteJob('${job.id}')" class="btn btn-danger">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
            });
        }

        function updateJobStatus(jobId, newStatus) {
            const job = jobs.find(j => j.id === jobId);
            if (job) {
                job.status = newStatus;
                saveData();
                updateJobsList();
                updateDashboard();
            }
        }

        // Settings functions
        function updateSettings() {
            document.getElementById('settings-customers').textContent = customers.length;
            document.getElementById('settings-transactions').textContent = transactions.length;
            document.getElementById('settings-jobs').textContent = jobs.length;
            document.getElementById('settings-data-size').textContent = calculateDataSize();
            
            // Load business settings
            document.getElementById('business-name').value = businessSettings.businessName || '';
            document.getElementById('business-address').value = businessSettings.businessAddress || '';
            document.getElementById('business-phone').value = businessSettings.businessPhone || '';
            document.getElementById('currency-symbol').value = businessSettings.currencySymbol || '‚Çπ';
            
            // Load auto backup setting
            document.getElementById('auto-backup').checked = businessSettings.autoBackup || false;
            document.getElementById('last-backup').textContent = businessSettings.lastBackup ? 
                formatDate(businessSettings.lastBackup) : 'Never';
        }

        function saveBusinessSettings() {
            businessSettings.businessName = document.getElementById('business-name').value;
            businessSettings.businessAddress = document.getElementById('business-address').value;
            businessSettings.businessPhone = document.getElementById('business-phone').value;
            businessSettings.currencySymbol = document.getElementById('currency-symbol').value;
            saveData();
            
            // Update dashboard and other displays
            updateDashboard();
            updateTransactionsList();
            updateJobsList();
            
            alert('Business settings saved successfully!');
        }

        function toggleAutoBackup() {
            businessSettings.autoBackup = document.getElementById('auto-backup').checked;
            saveData();
            
            if (businessSettings.autoBackup) {
                alert('Auto backup enabled! Your data will be automatically exported weekly.');
                checkAutoBackup();
            }
        }

        function checkAutoBackup() {
            if (!businessSettings.autoBackup) return;
            
            const lastBackup = businessSettings.lastBackup ? new Date(businessSettings.lastBackup) : new Date(0);
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            if (lastBackup < weekAgo) {
                if (confirm('It\'s time for your weekly backup! Would you like to export your data now?')) {
                    exportData();
                    businessSettings.lastBackup = new Date().toISOString();
                    saveData();
                    updateSettings();
                }
            }
        }

        // Form handlers
        document.getElementById('customer-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customer = {
                id: generateId(),
                name: document.getElementById('customer-name').value,
                phone: document.getElementById('customer-phone').value,
                notes: document.getElementById('customer-notes').value,
                createdAt: new Date().toISOString()
            };
            
            customers.push(customer);
            saveData();
            this.reset();
            updateCustomersList();
            updateDashboard();
            alert('Customer added successfully!');
        });

        document.getElementById('transaction-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const transaction = {
                id: generateId(),
                customerId: document.getElementById('transaction-customer').value,
                workDescription: document.getElementById('transaction-work').value,
                date: document.getElementById('transaction-date').value || new Date().toISOString().split('T')[0],
                goldIn: parseFloat(document.getElementById('transaction-gold-in').value) || 0,
                goldOut: parseFloat(document.getElementById('transaction-gold-out').value) || 0,
                cashIn: parseFloat(document.getElementById('transaction-cash-in').value) || 0,
                labourCharge: parseFloat(document.getElementById('transaction-labour').value) || 0,
                remarks: document.getElementById('transaction-remarks').value,
                createdAt: new Date().toISOString()
            };
            
            transactions.push(transaction);
            saveData();
            this.reset();
            updateTransactionsList();
            updateDashboard();
            alert('Transaction added successfully!');
        });

        document.getElementById('job-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const job = {
                id: generateId(),
                customerId: document.getElementById('job-customer').value,
                workDescription: document.getElementById('job-work').value,
                status: document.getElementById('job-status').value,
                expectedDelivery: document.getElementById('job-delivery').value,
                createdAt: new Date().toISOString()
            };
            
            jobs.push(job);
            saveData();
            this.reset();
            updateJobsList();
            updateDashboard();
            alert('Job created successfully!');
        });

        // Delete functions
        function deleteCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            
            // Check for related transactions and jobs
            const customerTransactions = transactions.filter(t => t.customerId === customerId);
            const customerJobs = jobs.filter(j => j.customerId === customerId);
            
            if (customerTransactions.length > 0 || customerJobs.length > 0) {
                alert(`Cannot delete customer "${customer.name}". Customer has ${customerTransactions.length} transaction(s) and ${customerJobs.length} job(s). Delete them first.`);
                return;
            }
            
            if (confirm(`Are you sure you want to delete customer "${customer.name}"?\n\nThis action cannot be undone.`)) {
                customers = customers.filter(c => c.id !== customerId);
                saveData();
                updateCustomersList();
                updateDashboard();
                if (currentCustomer && currentCustomer.id === customerId) {
                    showCustomerList();
                }
                alert('Customer deleted successfully!');
            }
        }

        function deleteTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (confirm(`Are you sure you want to delete this transaction?\n\nWork: "${transaction.workDescription}"\n\nThis action cannot be undone and will affect balance calculations.`)) {
                transactions = transactions.filter(t => t.id !== transactionId);
                saveData();
                updateTransactionsList();
                updateDashboard();
                if (currentCustomer) {
                    showCustomerDetail(currentCustomer.id);
                }
                alert('Transaction deleted successfully!');
            }
        }

        function deleteJob(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (confirm(`Are you sure you want to delete this job?\n\nWork: "${job.workDescription}"\n\nThis action cannot be undone.`)) {
                jobs = jobs.filter(j => j.id !== jobId);
                saveData();
                updateJobsList();
                updateDashboard();
                alert('Job deleted successfully!');
            }
        }

        // Export/Import functions
        function exportData() {
            const data = {
                customers: customers,
                transactions: transactions,
                jobs: jobs,
                businessSettings: businessSettings,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `goldsmith-ledger-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            // Update last backup time if auto backup is enabled
            if (businessSettings.autoBackup) {
                businessSettings.lastBackup = new Date().toISOString();
                saveData();
                updateSettings();
            }
        }

        function exportCSV() {
            let csvContent = "Date,Customer,Work Description,Gold In (g),Gold Out (g),Cash In,Labour Charge,Remarks\n";
            
            transactions.forEach(transaction => {
                const customer = customers.find(c => c.id === transaction.customerId);
                csvContent += `"${transaction.date}","${customer ? customer.name : 'Unknown'}","${transaction.workDescription}","${transaction.goldIn || 0}","${transaction.goldOut || 0}","${transaction.cashIn || 0}","${transaction.labourCharge || 0}","${transaction.remarks || ''}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `goldsmith-transactions-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportCustomerReport() {
            const reportData = customers.map(customer => {
                const customerTransactions = transactions.filter(t => t.customerId === customer.id);
                let goldBalance = 0;
                let moneyBalance = 0;
                
                customerTransactions.forEach(t => {
                    goldBalance += (parseFloat(t.goldIn) || 0) - (parseFloat(t.goldOut) || 0);
                    moneyBalance += (parseFloat(t.cashIn) || 0) + (parseFloat(t.labourCharge) || 0);
                });
                
                return {
                    name: customer.name,
                    phone: customer.phone || '',
                    goldBalance: goldBalance.toFixed(3),
                    moneyBalance: moneyBalance.toFixed(2),
                    totalTransactions: customerTransactions.length
                };
            });
            
            let csvContent = "Customer Name,Phone,Gold Balance (g),Money Balance,Total Transactions\n";
            reportData.forEach(customer => {
                csvContent += `"${customer.name}","${customer.phone}","${customer.goldBalance}","${customer.moneyBalance}","${customer.totalTransactions}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `customer-balances-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to import');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.customers && data.transactions && data.jobs) {
                        // Merge data (avoid duplicates by checking IDs)
                        data.customers.forEach(customer => {
                            if (!customers.find(c => c.id === customer.id)) {
                                customers.push(customer);
                            }
                        });
                        
                        data.transactions.forEach(transaction => {
                            if (!transactions.find(t => t.id === transaction.id)) {
                                transactions.push(transaction);
                            }
                        });
                        
                        data.jobs.forEach(job => {
                            if (!jobs.find(j => j.id === job.id)) {
                                jobs.push(job);
                            }
                        });
                        
                        if (data.businessSettings) {
                            businessSettings = {...businessSettings, ...data.businessSettings};
                        }
                        
                        saveData();
                        refreshAllViews();
                        alert('Data imported successfully!');
                    } else {
                        alert('Invalid file format');
                    }
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                }
            };
            reader.readAsText(file);
            fileInput.value = '';
        }

        function replaceData() {
            const fileInput = document.getElementById('replace-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to import');
                return;
            }
            
            if (!confirm('This will replace ALL current data. Are you sure you want to continue?')) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.customers && data.transactions && data.jobs) {
                        customers = data.customers;
                        transactions = data.transactions;
                        jobs = data.jobs;
                        
                        if (data.businessSettings) {
                            businessSettings = data.businessSettings;
                        }
                        
                        saveData();
                        refreshAllViews();
                        alert('Data replaced successfully!');
                    } else {
                        alert('Invalid file format');
                    }
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                }
            };
            reader.readAsText(file);
            fileInput.value = '';
        }

        function refreshAllViews() {
            updateDashboard();
            updateCustomersList();
            updateTransactionsList();
            updateJobsList();
            updateSettings();
        }

        function exportPDF() {
            // Simple PDF export using print functionality
            const printWindow = window.open('', '_blank');
            const reportHTML = generateReport();
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            printWindow.print();
        }

        function generateReport() {
            let totalGold = 0;
            let totalMoney = 0;
            
            transactions.forEach(t => {
                totalGold += (parseFloat(t.goldIn) || 0) - (parseFloat(t.goldOut) || 0);
                totalMoney += (parseFloat(t.cashIn) || 0) + (parseFloat(t.labourCharge) || 0);
            });

            const businessInfo = businessSettings.businessName ? 
                `<h1>${businessSettings.businessName}</h1>
                 <p>${businessSettings.businessAddress || ''}</p>
                 <p>${businessSettings.businessPhone || ''}</p>` : 
                '<h1>‚ú® Goldsmith Ledger Report</h1>';

            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Goldsmith Ledger Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .summary { margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f5f5f5; }
                        .text-right { text-align: right; }
                        .customer-summary { margin-bottom: 30px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        ${businessInfo}
                        <p>Generated on ${new Date().toLocaleString()}</p>
                    </div>
                    
                    <div class="summary">
                        <h2>Summary</h2>
                        <p><strong>Total Gold Balance:</strong> ${totalGold.toFixed(3)}g</p>
                        <p><strong>Total Money Balance:</strong> ${formatCurrency(totalMoney)}</p>
                        <p><strong>Total Customers:</strong> ${customers.length}</p>
                        <p><strong>Total Transactions:</strong> ${transactions.length}</p>
                        <p><strong>Total Jobs:</strong> ${jobs.length}</p>
                    </div>
                    
                    <div class="customer-summary">
                        <h2>Customer Balances</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Gold Balance</th>
                                    <th>Money Balance</th>
                                    <th>Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${customers.map(customer => {
                                    const customerTransactions = transactions.filter(t => t.customerId === customer.id);
                                    let goldBalance = 0;
                                    let moneyBalance = 0;
                                    
                                    customerTransactions.forEach(t => {
                                        goldBalance += (parseFloat(t.goldIn) || 0) - (parseFloat(t.goldOut) || 0);
                                        moneyBalance += (parseFloat(t.cashIn) || 0) + (parseFloat(t.labourCharge) || 0);
                                    });
                                    
                                    return `
                                        <tr>
                                            <td>${customer.name}</td>
                                            <td class="text-right">${goldBalance.toFixed(3)}g</td>
                                            <td class="text-right">${formatCurrency(moneyBalance)}</td>
                                            <td class="text-right">${customerTransactions.length}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <h2>Recent Transactions</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Work</th>
                                <th>Gold In</th>
                                <th>Gold Out</th>
                                <th>Cash In</th>
                                <th>Labour</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transactions.slice(-20).map(t => {
                                const customer = customers.find(c => c.id === t.customerId);
                                return `
                                    <tr>
                                        <td>${formatDate(t.date)}</td>
                                        <td>${customer ? customer.name : 'Unknown'}</td>
                                        <td>${t.workDescription}</td>
                                        <td class="text-right">${t.goldIn || 0}g</td>
                                        <td class="text-right">${t.goldOut || 0}g</td>
                                        <td class="text-right">${formatCurrency(t.cashIn)}</td>
                                        <td class="text-right">${formatCurrency(t.labourCharge)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <h2>Active Jobs</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Work Description</th>
                                <th>Status</th>
                                <th>Expected Delivery</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${jobs.filter(j => j.status !== 'Delivered').map(job => {
                                const customer = customers.find(c => c.id === job.customerId);
                                return `
                                    <tr>
                                        <td>${customer ? customer.name : 'Unknown'}</td>
                                        <td>${job.workDescription}</td>
                                        <td>${job.status}</td>
                                        <td>${job.expectedDelivery ? formatDate(job.expectedDelivery) : '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
        }

        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL data?\n\nThis will permanently remove all customers, transactions, and jobs.\n\nThis action cannot be undone!')) {
                if (confirm('Final confirmation: Delete everything?')) {
                    customers = [];
                    transactions = [];
                    jobs = [];
                    saveData();
                    
                    updateDashboard();
                    updateCustomersList();
                    updateTransactionsList();
                    updateJobsList();
                    updateSettings();
                    
                    alert('All data cleared successfully!');
                }
            }
        }

        // Initialize app
        function initApp() {
            // Set today's date as default for forms
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transaction-date').value = today;
            
            // Load initial data
            updateDashboard();
            updateCustomersList();
            updateTransactionsList();
            updateJobsList();
            updateSettings();
        }

        // Start the app when page loads
        document.addEventListener('DOMContentLoaded', initApp);

        // Register service worker for offline functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,Y29uc3QgQ0FDSEVfTkFNRSA9ICdnb2xkc21pdGgtbGVkZ2VyLW9mZmxpbmUtdjEnOwpjb25zdCB1cmxzVG9DYWNoZSA9IFsKICAnLycKXTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignaW5zdGFsbCcsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgZXZlbnQud2FpdFVudGlsKAogICAgY2FjaGVzLm9wZW4oQ0FDSEVfTkFNRSkKICAgICAgLnRoZW4oZnVuY3Rpb24oY2FjaGUpIHsKICAgICAgICByZXR1cm4gY2FjaGUuYWRkQWxsKHVybHNUb0NhY2hlKTsKICAgICAgfSkKICApOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignZmV0Y2gnLCBmdW5jdGlvbihldmVudCkgewogIGV2ZW50LnJlc3BvbmRXaXRoKAogICAgY2FjaGVzLm1hdGNoKGV2ZW50LnJlcXVlc3QpCiAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgaWYgKHJlc3BvbnNlKSB7CiAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmZXRjaChldmVudC5yZXF1ZXN0KTsKICAgICAgfQogICAgKQogICk7Cn0pOw==')
                .then(function(registration) {
                    console.log('SW registered: ', registration);
                })
                .catch(function(registrationError) {
                    console.log('SW registration failed: ', registrationError);
                });
        }
    </script>
</body>
</html>